<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expenses</title>
    <link rel="stylesheet" href="home.css">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>


<body>
    <div id="expenses">

        <div class="leftDiv">
            <div id="storeExpenses"></div>
        </div>
        <br>
        <div class="rightDiv">

            <div id="piechart"></div>

            <div class="getAndaddExpensesDiv">
                <br>
                <div class="addExpensesDiv">
                    <input type="text" placeholder="Expense name" id="expenseName">
                    <input type="text" placeholder="Amount" id="expenseAmount">

                    <label for="CategoryOfExpense">Category</label>
                    <select name="Category" id="CategoryOfExpense">
                        <option value="Housing">Housing</option>
                        <option value="Food & Groceries">Food & Groceries</option>
                        <option value="Transportation">Transportation</option>
                        <option value="Utilities">Utilities</option>
                        <option value="Education & Study">Education & Study</option>
                        <option value="Finance & Debt">Finance & Debt</option>
                    </select>
                    <button onclick="addExpenses()" id="addExpenses"> Add Expenses</button>
                </div>
            </div>
        </div>

    </div>
    <br> <br>
    <button onclick="logOut()" id="logOut">Log out</button>

    <script>
        function logOut() {
            localStorage.removeItem("token");
            window.location.href = "./index.html";
        }

        async function fetchExpenses() {
            // DOM concept
            const token = localStorage.getItem("token");
            const respond = {
                "message": [
                    {
                        "_id": "68bdf37eb4b71a6b10477cc3",
                        "userId": "68bdf21610e679ba67557e58",
                        "expenseTitle": "rf",
                        "expenseDiscription": "dfg, dfgd dfg dfg",
                        "category": "rg+",
                        "createdAt": "2025-09-07T21:05:02.267Z",
                        "updatedAt": "2025-09-07T21:05:02.267Z",
                        "__v": 0
                    },
                    {
                        "_id": "68c0967a366da157471a84ee",
                        "userId": "68bdf21610e679ba67557e58",
                        "expenseTitle": "rf",
                        "expenseDiscription": "dfg, dfgd dfg dfg",
                        "category": "rg+",
                        "createdAt": "2025-09-09T21:04:58.466Z",
                        "updatedAt": "2025-09-09T21:04:58.466Z",
                        "__v": 0
                    }
                ]
            }

            const expenses = respond.message; // store the 'array of Objects of expenses' from respondExpenses

            // store that all expense in html
            const element = document.getElementById("storeExpenses");

            element.innerHTML = "";

            const categoryTotal = {}; // empty object which will store totals by category

            for (let i = 0; i < expenses.length; i++) {
                // here each expense[i] has expense of different name so expense[i].nameOfobject is not possible so using KEYS and VALUE way

                const eachExpense = expenses[i]; // expenses is an array in which contains expense_name, cost, category

                const expense_name = eachExpense.expense_name;
                const expense_cost = Number(eachExpense.expense_cost);
                const CategoryOfExpense = eachExpense.CategoryOfExpense;
                const id = eachExpense.id;


                const finalExpense = `${expense_name} - ${expense_cost}`;
                const e = `<div id="contentExpense"> 
                    ${finalExpense} 
                    <button type="button" id="delete" onclick="deleteExpense(${id})"> Delete </button>
                    </div>
                     <br>`;
                element.innerHTML += e;

                // now logic for storing total expense cost by category
                if (categoryTotal[CategoryOfExpense] == undefined) // if there is no value for that specific category
                {
                    categoryTotal[CategoryOfExpense] = expense_cost;
                }
                else {  // if there is already value stored for that specific category then

                    categoryTotal[CategoryOfExpense] += expense_cost;
                }

                // here we need to pass the category and total expense of each category as array to the graph so

            }
            const dataArray = [["Category", "Value"]];
            for (let category in categoryTotal) { // here we used category as index
                dataArray.push([category, categoryTotal[category]]);   // push the category and value
            }

            drawChart(dataArray);
        }

        async function deleteExpense(id) {
            const respond = await axios({
                url: "http://localhost:3000/home/delete",
                data: { parseId: id },
                method: "DELETE",
            });
            alert(respond.data);
            // not callling fetchExpenses here cause it will not execute due to full page reload after route call (I can remove it by sending route delete request onSave)
        }


        async function addExpenses() {
            const expenseName = document.getElementById("expenseName").value;
            const expenseAmount = document.getElementById("expenseAmount").value;
            const CategoryOfExpense = document.getElementById("CategoryOfExpense").value;
            // alert(`${expenseName} - ${expenseAmount}`);

            const respond = await axios({
                url: "http://localhost:3000/home/add",
                data: { expense_name: expenseName, expense_cost: expenseAmount, CategoryOfExpense: CategoryOfExpense },
                method: "POST"
            });

            alert(respond.data);
        }
    </script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript">
        google.charts.load('current', { 'packages': ['corechart'] });

        google.charts.setOnLoadCallback(fetchExpenses); // calls fetchExpenses whenever loads

        function drawChart(dataArray) {

            var data = google.visualization.arrayToDataTable(dataArray);

            var options = {
                title: 'My Expenses',
                titleTextStyle: {
                    fontName: "",
                },
                backgroundColor: 'transparent', // make the background transparent
                chartArea: {
                    backgroundColor: 'transparent', // No white box behind pie
                }
            };
            var chart = new google.visualization.PieChart(document.getElementById('piechart'));

            chart.draw(data, options);
        }
    </script>
</body>


</html>